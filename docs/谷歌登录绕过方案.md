# Electron 应用绕过 Google 登录检测解决方案

## 问题描述

在 Electron 应用中通过 `<webview>` 标签访问 Google 服务（如 Gemini、ChatGPT 的 Google 登录）时，可能会遇到以下错误提示：

> **"此浏览器或应用可能不安全"**
> (This browser or app may not be secure)

这是因为 Google 的反欺诈系统检测到了非标准浏览器环境（Electron/Chromium 内核但非标准 Chrome）。

## 解决方案核心原理

要绕过此检测，必须在 **网络层** 和 **JavaScript 执行环境层** 同时进行深度伪装，确保两者表现出的特征完全一致，且不包含 Electron 的特征。

### 1. 网络层 (Main Process)
*   **User-Agent 伪装**：强制将所有发往 Google 的请求头的 `User-Agent` 替换为标准的、最新版的 Chrome UA。
*   **Client Hints 清理**：移除 `sec-ch-ua` 等 Client Hints 请求头。因为 Electron 默认会发送带有 "Electron" 标识的 Hints，如果它与伪装的 UA 不匹配，会被立即识别。

### 2. JS 环境层 (Preload Script)
*   **Navigator 对象覆盖**：在页面加载前（Preload 阶段），通过 `Object.defineProperty` 覆盖 `navigator.userAgent`，使其与网络层的 UA **完全一致**。
*   **特征隐藏**：移除 `navigator.webdriver`、`cdc_` 等自动化测试工具留下的标记。
*   **环境模拟**：Mock `window.chrome`、`navigator.plugins` 等对象，使其更像真实的 Chrome 浏览器。

---

## 具体实现步骤

### 第一步：主进程拦截 (src/main.ts)

在主进程中添加 `fixGoogleLogin` 函数，并在 `app.on('ready')` 中调用。

```typescript
import { session, app } from 'electron'

/**
 * 修复 Google 登录时的 "此浏览器或应用可能不安全" 提示
 */
async function fixGoogleLogin(partition?: string) {
  const ses = partition ? session.fromPartition(partition) : session.defaultSession

  // 建议在调试时开启，生产环境视情况而定
  // await ses.clearStorageData() 

  // 硬编码一个标准的 Chrome User-Agent
  const cleanUA = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'

  // 1. 设置全局 UA
  ses.setUserAgent(cleanUA)

  // 2. 强制拦截 Google 相关请求，确保 UA 绝对干净，并处理 Client Hints
  const filter = {
    urls: ['*://*.google.com/*', '*://accounts.google.com/*']
  }

  ses.webRequest.onBeforeSendHeaders(filter, (details, callback) => {
    const { requestHeaders } = details
    
    // 强制覆盖 User-Agent
    requestHeaders['User-Agent'] = cleanUA

    // 移除可能暴露 Electron 身份的 Client Hints
    delete requestHeaders['sec-ch-ua']
    delete requestHeaders['sec-ch-ua-mobile']
    delete requestHeaders['sec-ch-ua-platform']
    delete requestHeaders['sec-ch-ua-full-version']
    delete requestHeaders['sec-ch-ua-full-version-list']

    callback({ requestHeaders })
  })
}

app.on('ready', () => {
    fixGoogleLogin()
    // ... 其他代码
})
```

### 第二步：Preload 脚本注入 (src/webview-preload.ts)

在 `<webview>` 的 preload 脚本中注入反检测代码。**关键点是 UA 必须与主进程完全一致。**

```typescript
// ... 其他反检测代码 (移除 webdriver, cdc_ 等) ...

// 7. Ensure User-Agent consistency in Main World
// 必须使用与 main.ts 中完全相同的字符串！
const newUA = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';

console.log('[Webview Preload] Overriding UserAgent to:', newUA);
Object.defineProperty(navigator, 'userAgent', {
  get: () => newUA,
  configurable: true
});

// ... 其他 Mock 代码 (window.chrome, plugins 等) ...
```

### 第三步：渲染进程清理 (src/renderer.ts)

确保渲染进程不要手动设置 `<webview>` 的 `useragent` 属性，否则可能会覆盖主进程的设置或导致不一致。

```typescript
// src/renderer.ts

// ❌ 不要这样做：
// webview.useragent = "..." 

// ✅ 保持默认，让主进程的 session 拦截器处理
```

## 调试技巧

1.  **开启开发者工具**：
    *   主窗口：`browserWindow.webContents.openDevTools()`
    *   Webview：`webview.openDevTools()`
2.  **检查 Network**：
    *   在 Webview 的开发者工具中，查看 `accounts.google.com` 的请求头。
    *   确认 `User-Agent` 是伪装后的 Chrome 版本。
    *   确认 `sec-ch-ua` 不包含 "Electron"。
3.  **检查 Console**：
    *   在 Console 中输入 `navigator.userAgent`，确认输出与请求头一致。
    *   输入 `navigator.webdriver`，确认返回 `undefined` 或 `false`。

## 常见问题

*   **依然提示不安全？**
    *   尝试清除缓存：`session.defaultSession.clearStorageData()`。
    *   检查 IP 是否被列入黑名单。
    *   确保 `src/main.ts` 中添加了 `app.commandLine.appendSwitch('disable-blink-features', 'AutomationControlled')`。
